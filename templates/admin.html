<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 1400px; margin: 20px auto; padding: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2.5rem; font-weight: bold; color: #667eea; margin-bottom: 10px; }
        .stat-label { color: #666; font-size: 14px; }
        .section { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .section-title { font-size: 1.5rem; color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background: #f8f9fa; font-weight: bold; color: #2c3e50; }
        tr:hover { background: #f8f9fa; }
        .btn { padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #5568d3; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .logout-btn { background: #95a5a6; padding: 10px 20px; color: white; text-decoration: none; border-radius: 5px; }
        .pattern-item { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #667eea; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Admin Panel</h1>
        <div>
            <span id="adminName"></span>
            <a href="/" class="logout-btn">‚Üê Back to App</a>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCases">0</div>
                <div class="stat-label">Total Cases</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalFeedback">0</div>
                <div class="stat-label">User Feedback</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="learnedPatterns">0</div>
                <div class="stat-label">Learned Patterns</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgAccuracy">0%</div>
                <div class="stat-label">Average Accuracy</div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">üìä Learned Patterns</div>
            <div id="patternsList"></div>
        </div>

        <div class="section">
            <div class="section-title">üéØ Breed Feedback</div>
            <div id="breedFeedback"></div>
        </div>

        <div class="section">
            <div class="section-title">üìù Recent Cases</div>
            <table id="casesTable">
                <thead>
                    <tr>
                        <th>Case ID</th>
                        <th>Symptoms</th>
                        <th>Prediction</th>
                        <th>Timestamp</th>
                        <th>Feedback</th>
                    </tr>
                </thead>
                <tbody id="casesBody"></tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-title">‚öôÔ∏è System Actions</div>
            <button class="btn" onclick="exportData()">üì• Export Learning Data</button>
            <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è Clear All Data</button>
            <button class="btn" onclick="retrainModel()">üîÑ Retrain Model</button>
        </div>
    </div>

    <script>
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (user.role !== 'admin') {
            alert('Access denied. Admin only.');
            window.location.href = '/';
        }

        document.getElementById('adminName').textContent = `üë§ ${user.username}`;

        async function loadStats() {
            try {
                const response = await fetch('/api/learning/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('totalCases').textContent = stats.total_cases;
                    document.getElementById('totalFeedback').textContent = stats.total_feedback;
                    document.getElementById('learnedPatterns').textContent = stats.learned_patterns;
                    
                    let totalCorrect = 0, totalCases = 0;
                    for (let disease in stats.accuracy_data) {
                        totalCorrect += stats.accuracy_data[disease].correct;
                        totalCases += stats.accuracy_data[disease].total;
                    }
                    const avgAccuracy = totalCases > 0 ? ((totalCorrect / totalCases) * 100).toFixed(1) : 0;
                    document.getElementById('avgAccuracy').textContent = avgAccuracy + '%';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadPatterns() {
            try {
                const response = await fetch('/api/admin/patterns');
                const data = await response.json();
                
                if (data.success) {
                    const patternsDiv = document.getElementById('patternsList');
                    let html = '';
                    
                    for (let pattern in data.patterns) {
                        const diseases = data.patterns[pattern];
                        html += `
                            <div class="pattern-item">
                                <strong>Pattern:</strong> ${pattern}<br>
                                <strong>Diseases:</strong> ${JSON.stringify(diseases)}
                            </div>
                        `;
                    }
                    
                    patternsDiv.innerHTML = html || '<p>No patterns learned yet.</p>';
                }
            } catch (error) {
                console.error('Error loading patterns:', error);
            }
        }

        async function loadCases() {
            try {
                const response = await fetch('/api/admin/cases?limit=20');
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('casesBody');
                    let html = '';
                    
                    data.cases.forEach(c => {
                        const symptoms = Object.keys(c.symptoms || {}).filter(k => c.symptoms[k] !== 'no' && c.symptoms[k] !== 'unknown').join(', ');
                        const feedback = c.feedback ? `‚≠ê${c.feedback.rating || 'N/A'}` : 'No feedback';
                        
                        html += `
                            <tr>
                                <td>${c.case_id}</td>
                                <td>${symptoms}</td>
                                <td>${c.disease_prediction?.disease || 'N/A'}</td>
                                <td>${new Date(c.timestamp).toLocaleString()}</td>
                                <td>${feedback}</td>
                            </tr>
                        `;
                    });
                    
                    tbody.innerHTML = html || '<tr><td colspan="5">No cases yet.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading cases:', error);
            }
        }

        async function exportData() {
            try {
                const response = await fetch('/api/admin/export');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `learning_data_${Date.now()}.json`;
                a.click();
                alert('Data exported successfully!');
            } catch (error) {
                alert('Export failed: ' + error.message);
            }
        }

        async function clearData() {
            if (!confirm('Are you sure? This will delete all learning data!')) return;
            
            try {
                const response = await fetch('/api/admin/clear', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('All data cleared!');
                    location.reload();
                }
            } catch (error) {
                alert('Clear failed: ' + error.message);
            }
        }

        async function retrainModel() {
            if (!confirm('Retrain model with learned patterns?')) return;
            
            alert('Model retraining started. This may take a few minutes...');
            
            try {
                const response = await fetch('/api/admin/retrain', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('Model retrained successfully!');
                }
            } catch (error) {
                alert('Retrain failed: ' + error.message);
            }
        }

        loadStats();
        loadPatterns();
        loadCases();
        loadBreedFeedback();
        
        async function loadBreedFeedback() {
            try {
                const response = await fetch('/api/admin/breed-feedback');
                const data = await response.json();
                
                if (data.success) {
                    const feedbackDiv = document.getElementById('breedFeedback');
                    let html = `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <strong>Total Feedback:</strong> ${data.stats.total}<br>
                            <strong>Correct:</strong> ${data.stats.correct} (${data.stats.accuracy}%)<br>
                            <strong>Wrong:</strong> ${data.stats.wrong}
                        </div>
                    `;
                    
                    if (data.corrections && Object.keys(data.corrections).length > 0) {
                        html += '<h4>Corrections Received:</h4>';
                        for (let [predicted, corrections] of Object.entries(data.corrections)) {
                            html += `<div style="background: white; padding: 10px; margin: 5px 0; border-radius: 5px;">
                                <strong>${predicted}</strong> ‚Üí ${corrections.join(', ')}
                            </div>`;
                        }
                    }
                    
                    feedbackDiv.innerHTML = html || '<p>No breed feedback yet.</p>';
                }
            } catch (error) {
                console.error('Error loading breed feedback:', error);
            }
        }

        setInterval(() => {
            loadStats();
            loadCases();
            loadBreedFeedback();
        }, 30000);
    </script>
</body>
</html>
