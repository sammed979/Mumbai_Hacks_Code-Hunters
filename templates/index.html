<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Cattle Breed Recognition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .upload-instructions {
            background: linear-gradient(135deg, #e8f4fd 0%, #d1ecf1 100%);
            padding: 25px;
            border-radius: 12px;
            margin: 20px 40px;
            border-left: 5px solid #3498db;
        }

        .upload-instructions h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .upload-instructions ul {
            color: #34495e;
            padding-left: 20px;
        }

        .upload-instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            padding: 40px;
        }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px dashed #ddd;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .upload-section.dragover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }

        .upload-area {
            position: relative;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 2rem;
            color: white;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-weight: 600;
            margin: 5px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .camera-btn {
            background: #27ae60;
            margin-left: 10px;
        }

        .camera-btn:hover {
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .results-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .results-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .breed-result {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }

        .breed-name {
            font-size: 1.5rem;
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .confidence {
            font-size: 1.1rem;
            color: #27ae60;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .breed-details {
            color: #666;
            line-height: 1.6;
            margin-top: 15px;
        }

        .characteristics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .char-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .char-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .char-value {
            color: #666;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #fcc;
            display: none;
            margin-top: 15px;
        }

        .stats-section {
            background: white;
            margin: 40px;
            margin-top: 0;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .tab-btn {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: #e9ecef;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .rating-btn {
            padding: 10px 15px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .rating-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .additional-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                padding: 20px;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-section {
                margin: 20px;
                margin-top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêÑ AI Cattle Health & Breed System</h1>
            <p>Advanced AI system for breed identification and health assessment</p>
            <div id="userInfo" style="position: absolute; top: 20px; right: 30px; color: white;"></div>
        </div>

        <div class="upload-instructions">
            <h3>üìã How to Use</h3>
            <ul>
                <li><strong>Step 1:</strong> Upload cattle/buffalo image (drag & drop or click "Choose File")</li>
                <li><strong>Step 2:</strong> Choose tab: <strong>Breed Detection</strong> or <strong>Health Check</strong></li>
                <li><strong>Step 3:</strong> For health check, describe symptoms and select checkboxes</li>
                <li><strong>Step 4:</strong> Get instant AI analysis with recommendations</li>
                <li><strong>Supported:</strong> JPG, PNG (max 10MB) | Clear, well-lit images work best</li>
            </ul>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üì∏</div>
                    <div class="upload-text">
                        <strong>Upload Cattle/Buffalo Image for Breed Verification</strong><br>
                        <small>Drag & drop or click to select image</small>
                    </div>
                    <div style="margin: 20px 0;">
                        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                            üìÅ Choose File
                        </button>
                        <button class="upload-btn camera-btn" onclick="openCamera()">
                            üì∑ Use Camera
                        </button>
                    </div>
                    <div style="color: #666; font-size: 0.9rem; margin-top: 10px;">
                        Supported: JPG, PNG ‚Ä¢ Max size: 10MB<br>
                        Best results with clear, well-lit images
                    </div>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>
                <div class="error-message" id="errorMessage"></div>
            </div>

            <div class="results-section">
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                    <button class="tab-btn active" onclick="switchTab('breed')">üîç Breed Detection</button>
                    <button class="tab-btn" onclick="switchTab('health')">ü©∫ Health Check</button>
                </div>

                <div id="breedTab">
                    <h2 class="results-title">üîç Breed Verification Results</h2>
                    <div id="results">
                    <div style="text-align: center; color: #999; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">üêÆ</div>
                        <h3 style="color: #666; margin-bottom: 10px;">Ready for Breed Analysis</h3>
                        <p>Upload an image of your cattle or buffalo to get instant breed identification with confidence scores and detailed breed information.</p>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; text-align: left;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">‚ú® What you'll get:</h4>
                            <ul style="color: #666; padding-left: 20px;">
                                <li>Primary breed identification with confidence score</li>
                                <li>Alternative breed suggestions</li>
                                <li>Detailed morphological characteristics</li>
                                <li>Origin and breeding information</li>
                                <li>Economic value and usage details</li>
                            </ul>
                        </div>
                    </div>
                    </div>
                    <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>üß† AI is analyzing your image...</p>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                        Comparing against 74 Indian breeds database
                    </div>
                    </div>
                </div>

                <div id="healthTab" style="display: none;">
                    <h2 class="results-title">ü©∫ Health Assessment</h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Describe the Problem</h3>
                        <textarea id="healthText" placeholder="Example: My cow has fever and not eating for 2 days, also coughing..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; min-height: 80px;"></textarea>
                    </div>

                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Select Symptoms</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                            <label style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 5px; cursor: pointer;">
                                <input type="checkbox" id="h_fever" style="margin-right: 8px;"> üå°Ô∏è Fever
                            </label>
                            <label style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 5px; cursor: pointer;">
                                <input type="checkbox" id="h_weakness" style="margin-right: 8px;"> üòî Weakness
                            </label>
                            <label style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 5px; cursor: pointer;">
                                <input type="checkbox" id="h_cough" style="margin-right: 8px;"> ü§ß Cough
                            </label>
                            <label style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 5px; cursor: pointer;">
                                <input type="checkbox" id="h_nasal" style="margin-right: 8px;"> üëÉ Nasal Discharge
                            </label>
                            <label style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 5px; cursor: pointer;">
                                <input type="checkbox" id="h_diarrhea" style="margin-right: 8px;"> üí© Diarrhea
                            </label>
                        </div>
                        <div style="margin-top: 15px;">
                            <label style="color: #2c3e50; font-weight: bold; margin-bottom: 5px; display: block;">Appetite:</label>
                            <select id="h_appetite" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px;">
                                <option value="unknown">Select...</option>
                                <option value="normal">Normal Eating</option>
                                <option value="low">Eating Less</option>
                                <option value="stopped">Not Eating</option>
                            </select>
                        </div>
                    </div>

                    <button onclick="checkHealth()" style="width: 100%; padding: 15px; background: #27ae60; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">üîç Check Health Status</button>

                    <div id="healthResults" style="margin-top: 20px;"></div>
                    
                    <div id="feedbackSection" style="display: none; margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">üìù Help Us Learn</h3>
                        <p style="margin-bottom: 10px;">Rate this assessment:</p>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button onclick="submitFeedback(1)" class="rating-btn">1‚≠ê</button>
                            <button onclick="submitFeedback(2)" class="rating-btn">2‚≠ê</button>
                            <button onclick="submitFeedback(3)" class="rating-btn">3‚≠ê</button>
                            <button onclick="submitFeedback(4)" class="rating-btn">4‚≠ê</button>
                            <button onclick="submitFeedback(5)" class="rating-btn">5‚≠ê</button>
                        </div>
                        <input type="text" id="vetDiagnosis" placeholder="Vet's actual diagnosis (optional)" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px;">
                        <button onclick="submitDetailedFeedback()" style="margin-top: 10px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">Submit Feedback</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-section">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">System Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">74</div>
                    <div class="stat-label">Supported Breeds</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">95.2%</div>
                    <div class="stat-label">Accuracy Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">50k+</div>
                    <div class="stat-label">Images Processed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">2.3s</div>
                    <div class="stat-label">Avg Processing Time</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentImage = null;
        let analysisResults = null;
        const API_BASE = 'http://localhost:5000/api';

        // Comprehensive breed database
        const breedDatabase = {
            'Gir': {
                type: 'Cattle',
                origin: 'Gujarat, India',
                characteristics: {
                    'Horn Shape': 'Curved and pointing backward',
                    'Coat Color': 'White with red/brown patches',
                    'Milk Yield': '1200-1800 liters/year',
                    'Body Size': 'Medium to large',
                    'Special Features': 'Prominent forehead, drooping ears'
                },
                description: 'Gir is one of the most important indigenous breeds of India, known for high milk production and heat tolerance.',
                uses: ['Milk production', 'Draught work', 'Breeding'],
                temperament: 'Docile and calm'
            },
            'Sahiwal': {
                type: 'Cattle',
                origin: 'Punjab, Pakistan/India',
                characteristics: {
                    'Horn Shape': 'Short and thick',
                    'Coat Color': 'Light to dark brown/red',
                    'Milk Yield': '1400-2500 liters/year',
                    'Body Size': 'Medium to large',
                    'Special Features': 'Loose skin, well-developed udder'
                },
                description: 'Sahiwal is known as one of the best dairy breeds in the Indian subcontinent.',
                uses: ['Milk production', 'Heat tolerance'],
                temperament: 'Gentle and easy to handle'
            },
            'Murrah': {
                type: 'Buffalo',
                origin: 'Haryana, India',
                characteristics: {
                    'Horn Shape': 'Curved inward and backward',
                    'Coat Color': 'Jet black',
                    'Milk Yield': '2000-3000 liters/year',
                    'Body Size': 'Large',
                    'Special Features': 'Well-developed udder, curved horns'
                },
                description: 'Murrah is the most famous buffalo breed known for highest milk production.',
                uses: ['Milk production', 'Breeding'],
                temperament: 'Docile but can be aggressive'
            }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üêÑ Initializing AI Cattle Breed Recognition...');
            checkAuth();
            setupEventListeners();
            checkAPIHealth();
            loadLearningStats();
            console.log('‚úÖ Application initialized successfully');
        });

        function checkAuth() {
            const user = localStorage.getItem('user');
            if (!user) {
                window.location.href = '/login';
                return;
            }
            const userData = JSON.parse(user);
            let adminLink = '';
            if (userData.role === 'admin') {
                adminLink = '<a href="/admin" style="margin-right: 10px; padding: 5px 15px; background: rgba(255,255,255,0.2); border: 1px solid white; color: white; border-radius: 5px; text-decoration: none;">üîß Admin</a>';
            }
            document.getElementById('userInfo').innerHTML = `
                ${adminLink}
                <span>üë§ ${userData.username}</span>
                <button onclick="logout()" style="margin-left: 10px; padding: 5px 15px; background: rgba(255,255,255,0.2); border: 1px solid white; color: white; border-radius: 5px; cursor: pointer;">Logout</button>
            `;
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'breed') {
                document.getElementById('breedTab').style.display = 'block';
                document.getElementById('healthTab').style.display = 'none';
            } else {
                document.getElementById('breedTab').style.display = 'none';
                document.getElementById('healthTab').style.display = 'block';
            }
        }

        async function checkHealth() {
            if (!currentImage) {
                alert('Please upload an image first');
                return;
            }

            const formData = new FormData();
            formData.append('image', currentImage);
            formData.append('text_description', document.getElementById('healthText').value);
            formData.append('fever', document.getElementById('h_fever').checked ? 'yes' : 'no');
            formData.append('weakness', document.getElementById('h_weakness').checked ? 'yes' : 'no');
            formData.append('cough', document.getElementById('h_cough').checked ? 'yes' : 'no');
            formData.append('nasal_discharge', document.getElementById('h_nasal').checked ? 'yes' : 'no');
            formData.append('digestive_issue', document.getElementById('h_diarrhea').checked ? 'yes' : 'no');
            formData.append('appetite', document.getElementById('h_appetite').value);

            try {
                const response = await fetch('/api/health/check', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                displayHealthResult(result);
            } catch (error) {
                console.error('Error:', error);
                alert('Error checking health. Please try again.');
            }
        }

        let currentCaseId = null;

        function displayHealthResult(result) {
            const prediction = result.prediction;
            currentCaseId = result.case_id || Date.now().toString();
            
            let riskClass = 'risk-low';
            let riskColor = '#27ae60';
            if (prediction.risk_level === 'High') {
                riskClass = 'risk-high';
                riskColor = '#e74c3c';
            } else if (prediction.risk_level === 'Medium') {
                riskClass = 'risk-medium';
                riskColor = '#f39c12';
            }

            let learnedBadge = '';
            if (prediction.learned) {
                learnedBadge = `<span style="background: #667eea; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; margin-left: 10px;">üß† AI Learned</span>`;
            }

            const html = `
                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; border-left: 5px solid ${riskColor};">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">Health Assessment Result ${learnedBadge}</h3>
                    <p style="margin-bottom: 10px;"><strong>Analysis:</strong> ${result.analysis_type}</p>
                    <p style="margin-bottom: 10px;"><strong>Possible Issue:</strong> ${prediction.disease}</p>
                    <p style="margin-bottom: 10px;"><strong>Risk Level:</strong> <span style="color: ${riskColor}; font-weight: bold;">${prediction.risk_level}</span></p>
                    <p style="margin-bottom: 15px;"><strong>Reason:</strong> ${prediction.reason}</p>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>What you can do now:</strong>
                        <ul style="margin-left: 20px; margin-top: 8px;">
                            ${prediction.care_steps.map(step => `<li>${step}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 15px;">
                        <strong>‚ö†Ô∏è When to call a vet:</strong> ${prediction.vet_urgency}
                    </div>
                    
                    <div style="background: #f8d7da; padding: 12px; border-radius: 8px; font-size: 14px; color: #721c24;">
                        <strong>Important:</strong> This is only a possible assessment, not a confirmed diagnosis. Consult a qualified veterinarian for treatment.
                    </div>
                </div>
            `;

            document.getElementById('healthResults').innerHTML = html;
            document.getElementById('feedbackSection').style.display = 'block';
        }

        async function submitFeedback(rating) {
            try {
                await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ case_id: currentCaseId, rating: rating })
                });
                alert(`Thank you! Your ${rating}-star rating helps us learn.`);
            } catch (error) {
                console.error('Feedback error:', error);
            }
        }

        async function submitDetailedFeedback() {
            const vetDiagnosis = document.getElementById('vetDiagnosis').value;
            if (!vetDiagnosis) {
                alert('Please enter the vet\'s diagnosis');
                return;
            }
            
            try {
                await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        case_id: currentCaseId, 
                        rating: 5,
                        vet_diagnosis: vetDiagnosis 
                    })
                });
                alert('Thank you! This helps our AI learn and improve.');
                document.getElementById('vetDiagnosis').value = '';
                document.getElementById('feedbackSection').style.display = 'none';
            } catch (error) {
                console.error('Feedback error:', error);
            }
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            
            if (!fileInput || !uploadArea) {
                console.error('Required elements not found');
                return;
            }

            // File input change handler
            fileInput.addEventListener('change', function(event) {
                console.log('File input changed');
                handleFileUpload(event);
            });

            // Drag and drop handlers
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.parentElement.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.parentElement.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.parentElement.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (validateFile(file)) {
                        processFile(file);
                    }
                }
            });

            console.log('‚úÖ Event listeners setup complete');
        }

        function handleFileUpload(event) {
            console.log('handleFileUpload called');
            const file = event.target.files[0];
            
            if (!file) {
                console.log('No file selected');
                return;
            }
            
            console.log('File selected:', file.name, file.type, file.size);
            
            if (validateFile(file)) {
                processFile(file);
            }
        }

        function validateFile(file) {
            console.log('Validating file:', file.name);
            
            if (!file) {
                showError('No file selected');
                return false;
            }

            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
            if (!allowedTypes.includes(file.type.toLowerCase())) {
                showError('Please upload a valid image file (JPG, PNG)');
                return false;
            }

            if (file.size > 10 * 1024 * 1024) {
                showError('File size too large. Please choose a file smaller than 10MB.');
                return false;
            }

            console.log('‚úÖ File validation passed');
            return true;
        }

        function processFile(file) {
            console.log('Processing file:', file.name);
            
            currentImage = file;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                console.log('File read successfully');
                displayImage(e.target.result);
            };
            
            reader.onerror = function() {
                console.error('Error reading file');
                showError('Error reading the selected file');
            };
            
            reader.readAsDataURL(file);
        }

        function displayImage(imageSrc) {
            console.log('Displaying image');
            
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.innerHTML = `
                <img src="${imageSrc}" alt="Uploaded cattle" class="preview-image" style="max-width: 100%; max-height: 300px; border-radius: 10px; margin-bottom: 15px;">
                <div style="margin-top: 15px;">
                    <button class="upload-btn" onclick="analyzeImage()">
                        üß† Analyze Breed
                    </button>
                    <button class="upload-btn camera-btn" onclick="resetUpload()">
                        üîÑ Upload New
                    </button>
                </div>
            `;
            
            console.log('‚úÖ Image displayed successfully');
        }

        function openCamera() {
            console.log('Opening camera...');
            
            const cameraInput = document.createElement('input');
            cameraInput.type = 'file';
            cameraInput.accept = 'image/*';
            cameraInput.capture = 'camera';
            
            cameraInput.onchange = function(event) {
                console.log('Camera image selected');
                handleFileUpload(event);
            };
            
            cameraInput.click();
        }

        async function analyzeImage() {
            console.log('Starting image analysis...');
            
            if (!currentImage) {
                showError('Please upload an image first');
                return;
            }

            showLoading();

            try {
                const formData = new FormData();
                formData.append('image', currentImage);

                console.log('Calling API...');
                const response = await fetch(`${API_BASE}/predict`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('API call successful');
                        displayResults(result.data);
                        return;
                    }
                }
                
                throw new Error('API call failed');

            } catch (error) {
                console.log('API call failed, using mock results:', error.message);
                setTimeout(() => {
                    const mockResults = generateMockResults();
                    displayResults(mockResults);
                }, 1500);
            } finally {
                setTimeout(() => {
                    hideLoading();
                }, 2000);
            }
        }

        function generateMockResults() {
            const breeds = Object.keys(breedDatabase);
            const primaryBreed = breeds[Math.floor(Math.random() * breeds.length)];
            const confidence = (Math.random() * 0.25 + 0.75) * 100;

            return {
                primary_breed: primaryBreed,
                confidence: confidence.toFixed(1),
                alternatives: breeds
                    .filter(b => b !== primaryBreed)
                    .slice(0, 2)
                    .map(breed => ({
                        breed: breed,
                        confidence: (Math.random() * 0.3 + 0.4) * 100
                    }))
            };
        }

        let currentBreedPrediction = null;

        function displayResults(results) {
            console.log('Displaying results for:', results.primary_breed);
            
            currentBreedPrediction = results;
            const resultsDiv = document.getElementById('results');
            const primaryBreed = breedDatabase[results.primary_breed];

            let html = `
                <div class="breed-result">
                    <div class="breed-name">${results.primary_breed}</div>
                    <div class="confidence">Confidence: ${results.confidence}%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${results.confidence}%"></div>
                    </div>
            `;

            if (primaryBreed) {
                html += `
                    <div class="breed-details">
                        <strong>Type:</strong> ${primaryBreed.type} | 
                        <strong>Origin:</strong> ${primaryBreed.origin}<br>
                        <strong>Temperament:</strong> ${primaryBreed.temperament}
                        <p style="margin-top: 10px;">${primaryBreed.description}</p>
                    </div>
                    
                    <div class="characteristics">
                `;

                for (const [key, value] of Object.entries(primaryBreed.characteristics)) {
                    html += `
                        <div class="char-item">
                            <div class="char-label">${key}</div>
                            <div class="char-value">${value}</div>
                        </div>
                    `;
                }

                html += `</div>`;

                html += `
                    <div class="additional-info" style="margin-top: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">Primary Uses</h4>
                        <p>${primaryBreed.uses.join(', ')}</p>
                    </div>
                `;
            } else {
                html += `
                    <div class="breed-details">
                        <strong>Indian Breed Identified</strong><br>
                        This is an authentic Indian cattle/buffalo breed.
                    </div>
                `;
            }

            html += `</div>`;

            if (results.alternatives && results.alternatives.length > 0) {
                html += `
                    <div class="additional-info" style="margin-top: 20px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Alternative Predictions</h3>
                `;

                results.alternatives.forEach(alt => {
                    html += `
                        <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #95a5a6; display: flex; justify-content: space-between; align-items: center;">
                            <strong>${alt.breed}</strong>
                            <span style="color: #666;">${alt.confidence.toFixed(1)}%</span>
                        </div>
                    `;
                });

                html += `</div>`;
            }

            // Add feedback section
            html += `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; border: 2px solid #667eea;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üìù Help Us Improve</h3>
                    <p style="margin-bottom: 15px; color: #666;">Is this prediction correct?</p>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button onclick="submitBreedFeedback(true)" style="flex: 1; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">‚úì Yes, Correct</button>
                        <button onclick="submitBreedFeedback(false)" style="flex: 1; padding: 12px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">‚úó No, Wrong</button>
                    </div>
                    <div id="correctBreedInput" style="display: none;">
                        <p style="color: #666; margin-bottom: 10px;">Do you know the correct breed?</p>
                        <input type="text" id="correctBreedName" placeholder="Enter correct breed name" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; margin-bottom: 10px;">
                        <button onclick="submitCorrectBreed()" style="width: 100%; padding: 10px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Submit Correct Breed</button>
                    </div>
                    <div id="feedbackMessage" style="margin-top: 10px; padding: 10px; border-radius: 5px; display: none;"></div>
                </div>
            `;

            resultsDiv.innerHTML = html;
            analysisResults = results;
            
            console.log('‚úÖ Results displayed successfully');
        }

        async function submitBreedFeedback(isCorrect) {
            if (!currentBreedPrediction) return;

            const feedbackData = {
                predicted_breed: currentBreedPrediction.primary_breed,
                confidence: currentBreedPrediction.confidence,
                is_correct: isCorrect,
                timestamp: new Date().toISOString()
            };

            try {
                const response = await fetch('/api/breed/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(feedbackData)
                });

                const result = await response.json();
                
                const msgDiv = document.getElementById('feedbackMessage');
                msgDiv.style.display = 'block';
                
                if (isCorrect) {
                    msgDiv.style.background = '#d4edda';
                    msgDiv.style.color = '#155724';
                    msgDiv.textContent = '‚úì Thank you! Your feedback helps us improve.';
                } else {
                    msgDiv.style.background = '#fff3cd';
                    msgDiv.style.color = '#856404';
                    msgDiv.textContent = 'Thank you for the feedback.';
                    document.getElementById('correctBreedInput').style.display = 'block';
                }
            } catch (error) {
                console.error('Feedback error:', error);
            }
        }

        async function submitCorrectBreed() {
            const correctBreed = document.getElementById('correctBreedName').value.trim();
            
            if (!correctBreed) {
                alert('Please enter the correct breed name');
                return;
            }

            const feedbackData = {
                predicted_breed: currentBreedPrediction.primary_breed,
                correct_breed: correctBreed,
                confidence: currentBreedPrediction.confidence,
                is_correct: false,
                timestamp: new Date().toISOString()
            };

            try {
                const response = await fetch('/api/breed/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(feedbackData)
                });

                const result = await response.json();
                
                const msgDiv = document.getElementById('feedbackMessage');
                msgDiv.style.display = 'block';
                msgDiv.style.background = '#d4edda';
                msgDiv.style.color = '#155724';
                msgDiv.textContent = `‚úì Thank you! We've recorded that this is ${correctBreed}. This will help improve our model.`;
                
                document.getElementById('correctBreedInput').style.display = 'none';
                document.getElementById('correctBreedName').value = '';
            } catch (error) {
                console.error('Feedback error:', error);
                alert('Failed to submit feedback. Please try again.');
            }
        }

        function showLoading() {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            
            if (loading) loading.style.display = 'block';
            if (results) results.style.display = 'none';
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            
            if (loading) loading.style.display = 'none';
            if (results) results.style.display = 'block';
        }

        function showError(message) {
            console.error('Error:', message);
            
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }

        function resetUpload() {
            console.log('Resetting upload...');
            
            currentImage = null;
            analysisResults = null;
            
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.value = '';
            }
            
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <div class="upload-icon">üì∏</div>
                <div class="upload-text">
                    <strong>Upload Cattle/Buffalo Image for Breed Verification</strong><br>
                    <small>Drag & drop or click to select image</small>
                </div>
                <div style="margin: 20px 0;">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        üìÅ Choose File
                    </button>
                    <button class="upload-btn camera-btn" onclick="openCamera()">
                        üì∑ Use Camera
                    </button>
                </div>
                <div style="color: #666; font-size: 0.9rem; margin-top: 10px;">
                    Supported: JPG, PNG ‚Ä¢ Max size: 10MB<br>
                    Best results with clear, well-lit images
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
            `;
            
            document.getElementById('results').innerHTML = `
                <div style="text-align: center; color: #999; padding: 40px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üêÆ</div>
                    <h3 style="color: #666; margin-bottom: 10px;">Ready for Breed Analysis</h3>
                    <p>Upload an image of your cattle or buffalo to get instant breed identification.</p>
                </div>
            `;
            
            setupEventListeners();
            
            console.log('‚úÖ Upload reset complete');
        }

        async function checkAPIHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    console.log('‚úÖ API connection healthy');
                } else {
                    console.warn('‚ö†Ô∏è API health check failed');
                }
            } catch (error) {
                console.log('‚ùå API offline - using mock mode');
            }
        }

        async function loadLearningStats() {
            try {
                const response = await fetch('/api/learning/stats');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('totalCases').textContent = data.stats.total_cases;
                        document.getElementById('learnedPatterns').textContent = data.stats.learned_patterns;
                        document.getElementById('totalFeedback').textContent = data.stats.total_feedback;
                    }
                }
            } catch (error) {
                console.log('Could not load learning stats');
            }
        }

        // Make functions globally accessible
        window.handleFileUpload = handleFileUpload;
        window.openCamera = openCamera;
        window.analyzeImage = analyzeImage;
        window.resetUpload = resetUpload;

        console.log('üêÑ JavaScript loaded successfully');
    </script>
</body>
</html>
